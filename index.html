<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Jogos - Cear√° SC 2026</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Favicon (opcional) -->
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/pt/6/6a/Cear%C3%A1_Sporting_Club_logo.svg" />
</head>
<body>
    <!-- Bot√µes de controle -->
    <div id="controles">
        <button onclick="carregarJogos()" id="btnAtualizar">
            üîÑ Atualizar Jogos
        </button>
        <span style="color:#003366; font-weight:500;">‚öΩ Cear√° SC 2026</span>
    </div>

    <!-- Mapa -->
    <div id="map"></div>

    <!-- Loading spinner -->
    <div class="loading" id="loading">Carregando jogos</div>

    <!-- Scripts -->
    <!-- Primeiro carregamos o banco de est√°dios -->
    <script src="estadios.js"></script>
    
    <!-- Depois o Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Script principal da aplica√ß√£o -->
    <script>
        // ============================================
        // CONFIGURA√á√ÉO INICIAL DO MAPA
        // ============================================
        const map = L.map('map').setView([-15.788, -47.879], 4); // Centro do Brasil
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Vari√°vel global para armazenar marcadores atuais
        let marcadoresAtuais = [];

        // ============================================
        // FUN√á√ïES AUXILIARES
        // ============================================

        /**
         * Determina a cor do marcador baseado no resultado do jogo.
         * @param {Object} jogo - Objeto contendo o campo 'resultado'
         * @returns {string} C√≥digo da cor em hexadecimal
         */
        function getCorResultado(jogo) {
            // Se for jogo futuro
            if (jogo.resultado === "A definir") return '#6c757d'; // cinza
            
            // Formato esperado: "Cear√° X x Y Advers√°rio"
            const partes = jogo.resultado.split(' x ');
            if (partes.length !== 2) return '#6c757d';
            
            // Extrai os gols (remove "Cear√° " do primeiro)
            const golsCeara = parseInt(partes[0].replace('Cear√° ', ''));
            const golsAdv = parseInt(partes[1]);
            
            if (isNaN(golsCeara) || isNaN(golsAdv)) return '#6c757d';
            
            if (golsCeara > golsAdv) return '#28a745'; // verde (vit√≥ria)
            if (golsCeara < golsAdv) return '#dc3545'; // vermelho (derrota)
            return '#ffc107'; // amarelo (empate)
        }

        /**
         * Cria um √≠cone personalizado (c√≠rculo colorido) para o marcador.
         * @param {string} cor - C√≥digo da cor em hexadecimal
         * @returns {L.DivIcon} √çcone do Leaflet
         */
        function criarIcone(cor) {
            return L.divIcon({
                html: `<div style="background-color: ${cor}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.4);"></div>`,
                iconSize: [24, 24],
                popupAnchor: [0, -15],
                className: 'marcador-ceara'
            });
        }

        /**
         * Carrega os jogos do arquivo JSON e os exibe no mapa.
         * √â chamada ao abrir a p√°gina e ao clicar no bot√£o de atualizar.
         */
        async function carregarJogos() {
            // Mostra o indicador de carregamento
            document.getElementById('loading').style.display = 'block';
            
            // Remove todos os marcadores antigos do mapa
            marcadoresAtuais.forEach(m => map.removeLayer(m));
            marcadoresAtuais = [];
            
            try {
                // Faz o fetch do arquivo JSON (certifique-se de que o arquivo existe)
                const response = await fetch('jogos.json');
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const jogos = await response.json();
                
                // Array tempor√°rio para agrupar os marcadores e ajustar o zoom depois
                const grupoMarcadores = [];
                
                // Itera sobre cada jogo
                jogos.forEach(jogo => {
                    // Verifica se o est√°dio existe no banco de dados
                    const coords = estadios[jogo.estadio];
                    if (!coords) {
                        console.warn(`Est√°dio n√£o encontrado: "${jogo.estadio}" - jogo contra ${jogo.adversario} n√£o ser√° exibido.`);
                        return; // pula este jogo
                    }
                    
                    // Determina a cor do marcador
                    const cor = getCorResultado(jogo);
                    const icone = criarIcone(cor);
                    
                    // Constr√≥i o conte√∫do do popup com todas as informa√ß√µes dispon√≠veis
                    const popupContent = `
                        <div style="font-family: 'Segoe UI', sans-serif;">
                            <h3 style="margin:0 0 8px 0; color:#003366; border-bottom:2px solid #003366; padding-bottom:4px;">
                                ‚öΩ Cear√° x ${jogo.adversario}
                            </h3>
                            <p style="margin:4px 0;"><strong>üìÖ Data:</strong> ${jogo.data} ${jogo.horario ? '√†s ' + jogo.horario : ''}</p>
                            <p style="margin:4px 0;"><strong>üèüÔ∏è Est√°dio:</strong> ${jogo.estadio}</p>
                            <p style="margin:4px 0;"><strong>üèÜ Competi√ß√£o:</strong> ${jogo.competicao || 'N√£o informada'}</p>
                            <p style="margin:4px 0;"><strong>üì∫ Transmiss√£o:</strong> ${jogo.transmissao || 'A definir'}</p>
                            <p style="margin:8px 0 0 0; font-size:1.2em; font-weight:bold; color:${cor};">
                                ${jogo.resultado}
                            </p>
                        </div>
                    `;
                    
                    // Cria o marcador e adiciona ao mapa
                    const marcador = L.marker(coords, { icon: icone })
                        .bindPopup(popupContent, { maxWidth: 260 });
                    
                    marcador.addTo(map);
                    marcadoresAtuais.push(marcador);
                    grupoMarcadores.push(marcador);
                });
                
                // Ajusta o zoom para que todos os marcadores fiquem vis√≠veis
                if (grupoMarcadores.length > 0) {
                    const group = L.featureGroup(grupoMarcadores);
                    map.fitBounds(group.getBounds().pad(0.15)); // padding de 15%
                }
                
                // ============================================
                // ADICIONA LEGENDA (se ainda n√£o existir)
                // ============================================
                // Verifica se a legenda j√° foi adicionada para n√£o duplicar
                if (!window.legendaAdicionada) {
                    const legend = L.control({ position: 'bottomright' });
                    legend.onAdd = function() {
                        const div = L.DomUtil.create('div', 'legenda');
                        div.innerHTML = `
                            <div><i style="background:#28a745;"></i> Vit√≥ria do Cear√°</div>
                            <div><i style="background:#dc3545;"></i> Derrota do Cear√°</div>
                            <div><i style="background:#ffc107;"></i> Empate</div>
                            <div><i style="background:#6c757d;"></i> Jogo futuro</div>
                        `;
                        return div;
                    };
                    legend.addTo(map);
                    window.legendaAdicionada = true; // flag para n√£o adicionar novamente
                }
                
            } catch (error) {
                console.error('Erro ao carregar jogos:', error);
                alert('N√£o foi poss√≠vel carregar os jogos. Verifique se o arquivo "jogos.json" existe e est√° acess√≠vel.');
            } finally {
                // Esconde o loading
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ============================================
        // CARREGA OS JOGOS ASSIM QUE A P√ÅGINA ABRIR
        // ============================================
        window.addEventListener('load', carregarJogos);
    </script>
</body>
</html>
